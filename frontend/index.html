<!DOCTYPE html>
<html lang="de">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="theme-color" content="#3B7D23" />

		<title>Dashboard - Plant Manager</title>

		<!-- JQuerry für AJAX usw. -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

		<!-- Bootstrap CSS and icons -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
			
		<!-- Custom CSS -->
		<!-- Must be after Bootstrap CSS -->
		<link rel="stylesheet" href="./style.css">

		<!-- Common JS -->
		<script src="./js/common.js"></script>

		<script>

			function fetchPlants() {
				// AJAX request to fetch plant data
				// This runs asynchronously, so the rest of the code will run before this is done
				$.ajax({
					url: backendUrl_api + '/plants/all',
					method: 'GET',
					contentType: 'application/json; charset=utf-8',
					cache: false,
					dataType: 'json'
				}).done(function (response) {
					console.log(response);
					
					// TODO: Später testen, wie genau die response wirklich aussieht...
					displayPlants(response);

				}).fail(function (jqXHR, statusText, error) {
					let errorMessage = 'Response Code: ' + jqXHR.status + ' - Response Text: ' + jqXHR.responseText;
					console.log(errorMessage);
					displayError('Fehler beim Abrufen der Pflanzen: ' + errorMessage);
				});
			}

			function demoFetchPlants() {
				// This is a demo function to simulate fetching plants
				let response = [
					{
						"id": 1,
						"name": "Pflanziska",
						"species_name": "Glücksfeder",
						"image": "/images/plants/Ute.jpg",
						"added": "2023-03-14 10:30:56",
						"watering_interval": 14,
						"watering_interval_offset": -3,
						"watering_interval_calculated": 11,
						"days_since_watering": 10,
						"days_until_watering": 1,
						"repotted": "2023-03-14 10:30:56"
					},
					{
						"id": 2,
						"name": "Ute",
						"species_name": "Sukkulente",
						"image": "/images/plants/Ute.jpg",
						"added": "2023-03-14 10:30:56",
						"watering_interval": 7,
						"watering_interval_offset": -1,
						"watering_interval_calculated": 6,
						"days_since_watering": 6,
						"days_until_watering": 0,
						"repotted": "2023-03-14 10:30:56"
					},
					{
						"id": 3,
						"name": "Max",
						"species_name": "Kaktus",
						"image": "/images/plants/placeholder.svg",
						"added": "2023-03-14 10:30:56",
						"watering_interval": 21,
						"watering_interval_offset": -2,
						"watering_interval_calculated": 19,
						"days_since_watering": 20,
						"days_until_watering": -1,
						"repotted": "2023-03-14 10:30:56"
					}
				];
				displayPlants(response);
			}

			function displayPlants(plants) {
				// Clear the existing content
				$('#plants').empty();

				// TODO: Unrelevante Daten entfernen?
				// TODO: Pflanen sortieren? Backend oder Frontend?

				// Loop through the plants and create cards for each
				plants.forEach(function (plant) {
					let plantCard = createPlantCard(plant);
					$('#plants').append(plantCard);
				});
			}

			function createPlantCard(plant) {
				// This function should return a HTML Object that represents the plant card
				// See dynHtmlObj.html

				let wateringOverdue = false;
				if(plant.days_until_watering < 0)
				{
					wateringOverdue = true;
				}

				// Create col containing card
				let col = $('<div class="col">');
				let card = $('<div class="card">');
				col.append(card);
				
				// Create card structure
				let row = $('<div class="row g-0">');
				card.append(row);
				let imageContainer = $('<div class="col-5 col-sm-4 col-md-3 col-lg-5 col-xl-4">');
				let bodyContainer = $('<div class="col-7 col-sm-8 col-md-9 col-lg-7 col-xl-8">');
				row.append(imageContainer);
				row.append(bodyContainer);
				let cardFooter = $('<div class="card-footer">');
				card.append(cardFooter);

				// Fill image container
				let image = $('<img>');
				image.prop('alt','Bild von ' + plant.name);
				image.prop('src', backendUrl_plantImages + '/' + plant.image);
				image.prop('class','img-fluid rounded-start rounded-bottom-0');
				imageContainer.append(image);
				image.on("click", () => {
					showPlantDetailsPage(plant.id);
				});

				// Fill body container
				let cardBody = $('<div class="card-body">');
				bodyContainer.append(cardBody);

				cardBody.append($('<h5 class="card-title">' + plant.name + '</h5>'));
				let cardText = $('<p class="card-text">');
				cardBody.append(cardText);
				if(wateringOverdue)
				{
					cardText.text('Gießen überfällig seit ' + -plant.days_until_watering + ' Tagen');
				}
				else
				{
					cardText.text('Nächstes Gießen in ' + plant.days_until_watering + ' Tagen');
				}
				cardText.append('<br/>');
				cardText.append($('<small class="text-body-secondary">Zuletzt gegossen vor ' + plant.days_since_watering + ' Tagen</small>'));
				let buttonWater = $('<button type="button" class="btn btn-water"><i class="bi bi-droplet-fill"></i> Gießen</button>');
				cardBody.append(buttonWater);
				buttonWater.on("click", () => {
					// needed to be wraped in this anonymus function
					buttonWaterClick(plant);
				});

				// Fill card footer
				let progressbarContainer = $('<div class="progress" role="progressbar">');
				cardFooter.append(progressbarContainer);
				let progressbarFill = $('<div class="progress-bar">');
				if(wateringOverdue)
				{
					progressbarFill.prop("class", progressbarFill.prop("class") + " bg-danger");
					progressbarFill.prop('style','width:100%;');
				}
				else{
					progressbarFill.prop("class", progressbarFill.prop("class") + " bg-water");
					let percent = Math.round((plant.days_until_watering / plant.watering_interval_calculated) * 100);
					progressbarFill.prop('style','width:' + percent + '%;');
				}
				progressbarContainer.append(progressbarFill);

				// Add red border if watering is overdue
				if(wateringOverdue)
				{
					card.prop("class", card.prop("class") + " border-danger");
				}

				// Return the completed card
				return col;
			}

			async function buttonWaterClick(plant)
			{
				// call Backend
				let success = await waterPlant(plant);

				if (!success)
				{
					return;
				}
				
				// reload plants
				fetchPlants();
			}

			$(document).ready(function() {
				initializeAlertDisplay();
				console.log('Document ready, loading data from Service');
				fetchPlants();
				//demoFetchPlants(); // For testing purposes, remove this line in production
			});

		</script>

	</head>

	<body>
		<nav class="navbar sticky-top bg-primary navbar-expand-sm" data-bs-theme="dark"> 
			<div class="container-fluid">

				<a class="navbar-brand" href="dashboard.html">
					<img src="./images/logo_light.svg" alt="Logo" width="40" height="40" class="d-inline-block align-text-top">
				</a>

				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav">
						<li class="nav-item">
							<a class="nav-link active" aria-current="page" href="dashboard.html">Dashboard</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="meine_pflanzen.html">Meine Pflanzen</a>
						</li>
					</ul>
				</div>
				
			</div>
		</nav>

		<main class="container-lg">
			
			<!-- Ab hier Inhalt -->

			<div id="plants" class="row row-cols-1 row-cols-lg-2 g-3">

				<!-- Generated plant cards go in here -->

				<!-- Spinner is replaced with cards on success -->
				<div class="d-flex justify-content-center w-100">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
				</div>
			
			</div>

			<br/>
			<!-- Bis hier Inhalt -->
		
		</main>

		<!-- Bootstrap compiled and minified JavaScript -->
		<!-- Must be the last line inside the body!!! -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	</body>
</html>